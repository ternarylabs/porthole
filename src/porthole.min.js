{JSON=window.JSON||{};JSON.stringify=JSON.stringify||function(e){var t=typeof e;if(t!="object"||e===null){if(t=="string")e='"'+e+'"';return String(e)}else{var n,r,i=[],s=e&&e.constructor==Array;for(n in e){r=e[n];t=typeof r;if(t=="string")r='"'+r+'"';else if(t=="object"&&r!==null)r=JSON.stringify(r);i.push((s?"":'"'+n+'":')+String(r))}return(s?"[":"{")+String(i)+(s?"]":"}")}};JSON.parse=JSON.parse||function(str){if(str==="")str='""';eval("var p="+str+";");return p}}(function(){var e=false,t=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;this.PortholeClass=function(){};PortholeClass.extend=function(n){function o(){if(!e&&this.init)this.init.apply(this,arguments)}var r=this.prototype;e=true;var i=new this;e=false;for(var s in n){i[s]=typeof n[s]=="function"&&typeof r[s]=="function"&&t.test(n[s])?function(e,t){return function(){var n=this._super;this._super=r[e];var i=t.apply(this,arguments);this._super=n;return i}}(s,n[s]):n[s]}o.prototype=i;o.prototype.constructor=o;o.extend=arguments.callee;return o}})();(function(e){"use strict";var t={trace:function(t){if(e["console"]!==undefined){e.console.log("Porthole: "+t)}},error:function(t){if(e["console"]!==undefined){e.console.error("Porthole: "+t)}}};t.WindowProxy=function(){};t.WindowProxy.prototype={post:function(e,t){},addEventListener:function(e){},removeEventListener:function(e){}};t.WindowProxyBase=PortholeClass.extend({init:function(t){if(t===undefined){t=""}this.targetWindowName=t;this.origin=e.location.protocol+"//"+e.location.host;this.eventListeners=[]},getTargetWindowName:function(){return this.targetWindowName},getOrigin:function(){return this.origin},getTargetWindow:function(){return t.WindowProxy.getTargetWindow(this.targetWindowName)},post:function(t,n){if(n===undefined){n="*"}this.dispatchMessage({data:t,sourceOrigin:this.getOrigin(),targetOrigin:n,sourceWindowName:e.name,targetWindowName:this.getTargetWindowName()})},addEventListener:function(e){this.eventListeners.push(e);return e},removeEventListener:function(e){var t;try{t=this.eventListeners.indexOf(e);this.eventListeners.splice(t,1)}catch(n){this.eventListeners=[]}},dispatchEvent:function(e){var t;for(t=0;t<this.eventListeners.length;t++){try{this.eventListeners[t](e)}catch(n){}}}});t.WindowProxyLegacy=t.WindowProxyBase.extend({init:function(e,t){this._super(t);if(e!==null){this.proxyIFrameName=this.targetWindowName+"ProxyIFrame";this.proxyIFrameLocation=e;this.proxyIFrameElement=this.createIFrameProxy()}else{this.proxyIFrameElement=null;throw new Error("proxyIFrameUrl can't be null")}},createIFrameProxy:function(){var e=document.createElement("iframe");e.setAttribute("id",this.proxyIFrameName);e.setAttribute("name",this.proxyIFrameName);e.setAttribute("src",this.proxyIFrameLocation);e.setAttribute("frameBorder","1");e.setAttribute("scrolling","auto");e.setAttribute("width",30);e.setAttribute("height",30);e.setAttribute("style","position: absolute; left: -100px; top:0px;");if(e.style.setAttribute){e.style.setAttribute("cssText","position: absolute; left: -100px; top:0px;")}document.body.appendChild(e);return e},dispatchMessage:function(n){var r=e.encodeURIComponent;if(this.proxyIFrameElement){var i=this.proxyIFrameLocation+"#"+r(t.WindowProxy.serialize(n));this.proxyIFrameElement.setAttribute("src",i);this.proxyIFrameElement.height=this.proxyIFrameElement.height>50?50:100}}});t.WindowProxyHTML5=t.WindowProxyBase.extend({init:function(e,t){this._super(t);this.eventListenerCallback=null},dispatchMessage:function(e){this.getTargetWindow().postMessage(t.WindowProxy.serialize(e),e.targetOrigin)},addEventListener:function(t){if(this.eventListeners.length===0){var n=this;this.eventListenerCallback=function(e){n.eventListener(n,e)};e.addEventListener("message",this.eventListenerCallback,false)}return this._super(t)},removeEventListener:function(t){this._super(t);if(this.eventListeners.length===0){e.removeEventListener("message",this.eventListenerCallback);this.eventListenerCallback=null}},eventListener:function(e,n){var r=t.WindowProxy.unserialize(n.data);if(r&&(e.targetWindowName==""||r.sourceWindowName==e.targetWindowName)){e.dispatchEvent(new t.MessageEvent(r.data,n.origin,e))}}});if(typeof e.postMessage!=="function"){t.trace("Using legacy browser support");t.WindowProxy=t.WindowProxyLegacy.extend({})}else{t.trace("Using built-in browser support");t.WindowProxy=t.WindowProxyHTML5.extend({})}t.WindowProxy.serialize=function(e){if(typeof JSON==="undefined"){throw new Error("Porthole serialization depends on JSON!")}return JSON.stringify(e)};t.WindowProxy.unserialize=function(e){if(typeof JSON==="undefined"){throw new Error("Porthole unserialization dependens on JSON!")}try{var t=JSON.parse(e)}catch(n){return false}return t};t.WindowProxy.getTargetWindow=function(t){if(t===""){return top}else if(t==="top"||t==="parent"){return e[t]}return parent.frames[t]};t.MessageEvent=function(t,n,r){this.data=t;this.origin=n;this.source=r};t.WindowProxyDispatcher={forwardMessageEvent:function(n){var r,i=e.decodeURIComponent,s,o;if(document.location.hash.length>0){r=t.WindowProxy.unserialize(i(document.location.hash.substr(1)));s=t.WindowProxy.getTargetWindow(r.targetWindowName);o=t.WindowProxyDispatcher.findWindowProxyObjectInWindow(s,r.sourceWindowName);if(o){if(o.origin===r.targetOrigin||r.targetOrigin==="*"){o.dispatchEvent(new t.MessageEvent(r.data,r.sourceOrigin,o))}else{t.error("Target origin "+o.origin+" does not match desired target of "+r.targetOrigin)}}else{t.error("Could not find window proxy object on the target window")}}},findWindowProxyObjectInWindow:function(e,t){var n;if(e){for(n in e){if(Object.prototype.hasOwnProperty.call(e,n)){try{if(e[n]!==null&&typeof e[n]==="object"&&e[n]instanceof e.Porthole.WindowProxy&&e[n].getTargetWindowName()===t){return e[n]}}catch(r){}}}}return null},start:function(){if(e.addEventListener){e.addEventListener("resize",t.WindowProxyDispatcher.forwardMessageEvent,false)}else if(document.body.attachEvent){e.attachEvent("onresize",t.WindowProxyDispatcher.forwardMessageEvent)}else{t.error("Cannot attach resize event")}}};if(typeof e.exports!=="undefined"){e.exports.Porthole=t}else{e.Porthole=t}})(this)
